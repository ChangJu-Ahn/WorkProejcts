//
//	  Copyright (C) 2003-2014 GrapeCity Inc.	All rights reserved.
//

if(typeof GrapeCity=="undefined")GrapeCity={};if(!GrapeCity.Web)GrapeCity.Web={};if(!GrapeCity.Web.Spread)GrapeCity.Web.Spread={};GrapeCity.Web.Spread.FilterMenu=function(b,a){GrapeCity.Web.Spread.ContextMenu.call(this,b,null,a);this.IsFilterMenu=true};GrapeCity.Web.Spread.FilterMenu.prototype=new GrapeCity.Web.Spread.ContextMenu;GrapeCity.Web.Spread.FilterMenu.prototype.constructor=GrapeCity.Web.Spread.FilterMenu;GrapeCity.Web.Spread.FilterMenu.prototype.OnEscapePressed=function(){var a=this.ParentEditor;if(a.IsFilterBar&&a.TextBox!=null)$$(a.TextBox).focus(true);else this.__SpreadView.FocusSpread()};GrapeCity.Web.Spread.FilterEditor=function(a,b){this.Spread=a;this.Editor=b;this.FilterMenu=null;this.TreeView;this.TreeViewHasTime;this.IsFilterBar=this.Editor.id.indexOf(",fb")>0;this.Column=a.getSpreadView().GetFilterColumn(this.Editor.id);this.TextBox=null;this.DatePickerButton=null;this.DropDownButton=null;this.__ResetCommand=GrapeCity.Web.Spread.FilterEditor.__ResetCommand;this.__fiteredInfo=null;this.__dateCount=0;this.__SpreadView=this.Spread.getSpreadView();this.__Initialize()};GrapeCity.Web.Spread.FilterEditor.prototype={__Initialize:function(i){var n=$$.utils,a=null;if(i)a=document.getElementById(this.Editor.getAttribute("id")+"_CM");else do{a!=null&&a.parentNode.removeChild(a);a=document.getElementById(this.Editor.getAttribute("id")+"_CM")}while(a!=null&&(a.parentNode==document.body||a.parentNode.tagName=="FORM"));var f=a!=null?a.getAttribute("disabled"):this.Editor.getAttribute("disabled"),g=$$(this.Editor).getChildTag("DIV","dropdown");if(g!=null){if(!f)f=g.getAttribute("disabled");if(a==null){if(!i&&!f){var q=this.__SpreadView.__GetUnInitializedFilterEditors(true);q.push(this)}else if(f&&this.IsFilterBar){var b=$$(this.Editor).getChildTag("DIV","class","FilterBarDatePicker");if(b!=null){b.setAttribute("disabled","disabled");var s=b.getAttribute("Mode");if(s!="Show"){b.parentNode.style.display="none";b.parentNode.style.width="0px";b.parentNode.setAttribute("width","")}}}return}else if(i){var e=this.Editor,c=a.getAttribute("filterBackColors");if(c!=null){e.setAttribute("filterBackColors",c);e.setAttribute("selectedBackColor",a.getAttribute("selectedBackColor"));a.removeAttribute("filterBackColors");a.removeAttribute("selectedBackColor")}else{c=a.getAttribute("filterForeColors");if(c!=null){e.setAttribute("filterForeColors",c);e.setAttribute("selectedForeColor",a.getAttribute("selectedForeColor"));a.removeAttribute("filterForeColors");a.removeAttribute("selectedForeColor")}else{c=a.getAttribute("filterIcons");if(c!=null){e.setAttribute("filterIcons",c);e.setAttribute("selectedIcon",a.getAttribute("selectedIcon"));a.removeAttribute("filterIcons");a.removeAttribute("selectedIcon")}}}c=a.getAttribute("filterInfo");if(c!=null){e.setAttribute("filterInfo",c);a.removeAttribute("filterInfo")}}var t=this.Editor.getElementsByTagName("DIV"),p=n.firstTaggedChild(a,"UL");if(a!=null){var h=a.getAttribute("MainMenuType");if(h!=null){this.Editor.setAttribute("FilterMenuType",h);if(h=="Enhanced"){var l=a.getAttribute("CustomFilterMenuType");l!=null&&this.Editor.setAttribute("UpdateFilterMenuType",l)}}}var m=this.__GetMenuType();if(p!=null){this.FilterMenu=new GrapeCity.Web.Spread.FilterMenu(this.Spread,p,null);this.FilterMenu.Hide=Function.CreateDelegate(this,function(){GrapeCity.Web.Spread.ContextMenu.prototype.Hide.call(this.FilterMenu);this.__searchBox!=null&&this.__searchBox.DropDown!=null&&this.__searchBox.DropDown.Hide()});this.FilterMenu.OnItemKeyDown=Function.CreateDelegate(this,this.OnFilterMenuItemKeyDown);this.FilterMenu.OnMenuMouseDown=Function.CreateDelegate(this,this.OnFilterMenuMouseDown);this.FilterMenu.ParentEditor=this;this.FilterMenu.Column=this.Column}if(this.FilterMenu!=null){this.ItemClickEventHandler=Function.CreateDelegate(this,this.OnFilterMenuItemClick);this.FilterMenuOpeningEventHandler=Function.CreateDelegate(this,this.OnFilterMenuOpening);this.FilterMenuClosedEventHandler=Function.CreateDelegate(this,this.OnFilterMenuClosed);this.FilterMenu.AddInternalClickEvent(this.ItemClickEventHandler);this.FilterMenu.AddInternalOpeningEvent(this.FilterMenuOpeningEventHandler);this.FilterMenu.AddInternalClosedEvent(this.FilterMenuClosedEventHandler)}this.DropDownButton=g}var j=this.Editor.getAttribute("filterInfo");if(j!=null)this.__filteredInfo=JSON.parse(j);if(this.IsFilterBar){var b=$$(this.Editor).getChildTag("DIV","class","FilterBarDatePicker");if(b!=null&&b.getAttribute("Mode")=="Auto"){if(this.FilterMenu!=null&&this.FilterMenu.GetAttribute("CustomFilterMenuType")!="Date"||this.FilterMenu==null&&m!="Date"&&(m!="Enhanced"||this.Editor.getAttribute("UpdateFilterMenuType")!="Date")){b.parentNode.style.display="none";b.parentNode.style.width="0px"}else{b.parentNode.style.display="";b.parentNode.style.width="25px"}this.Editor.removeAttribute("UpdateFilterMenuType")}this.DatePickerButton=b;var d=n.firstTaggedChild(this.Editor,"INPUT",true);if(d!=null){this.TextBox=d;var o=this.Editor.getAttribute("dtf");if(o!=null)d._dateTimeFormat=JSON.parse(o);d._formatString=this.Editor.getAttribute("fs");this.textBoxFocusHandler=Function.CreateDelegate(this,this.OnFilterBarTextBoxFocus);FarPoint.System.AttachEvent(d,"focus",this.textBoxFocusHandler);this.textBoxBlurHandler=Function.CreateDelegate(this,this.OnFilterBarTextBoxBlur);FarPoint.System.AttachEvent(d,"blur",this.textBoxBlurHandler);this.textBoxKeyPressHandler=Function.CreateDelegate(this,this.OnFilterBarTextBoxKeyPress);FarPoint.System.AttachEvent(d,"keypress",this.textBoxKeyPressHandler);if(b!=null&&!d.disabled){this.__onDatePickerMouseClickHandler=Function.CreateDelegate(this,this.OnDatePickerClick);$$.utils.attachEvent(b,"click",this.__onDatePickerMouseClickHandler)}if(j!=null)this.__filteredValue=d.value;else this.__filteredValue=null;window.parent==window&&d==document.activeElement&&this.textBoxFocusHandler();d.tabIndex=-1;if($$.browser.webkit&&b){b.parentNode.style.width="22px";b.style.paddingRight="2px"}}var k=this.FilterMenu!=null?this.FilterMenu.GetSelectedItems():null;this.__filterCmd=k!=null?k[0].getAttribute("cmd"):null;if(f=="disabled"||f){a!=null&&a.removeAttribute("disabled");this._DisableFilterEditor()}else this._EnableFilterEditor()}this.editorMouseDownHandler=Function.CreateDelegate(this,this.OnEditorMouseDown);FarPoint.System.AttachEvent(this.Editor.parentNode,"mousedown",this.editorMouseDownHandler);this.editorMouseUpHandler=Function.CreateDelegate(this,this.OnEditorMouseUp);FarPoint.System.AttachEvent(this.Editor.parentNode,"mouseup",this.editorMouseUpHandler);this.editorClickHandler=Function.CreateDelegate(this,this.OnEditorClick);FarPoint.System.AttachEvent(this.Editor.parentNode,"click",this.editorClickHandler);$$.browser.ie&&$$.browser.version<10&&$$.browser.quirksMode&&this.__AdjustForQuirksMode();if(this.__SpreadView.__InDesign)if(this.IsFilterBar){this.Editor.style.position="static";var g=$$(this.Editor).getChildTag("DIV","dropdown");if(g)g.style.position="static"}if(this.IsFilterBar)this.LayoutFilterBar();else if($$.browser.ie&&$$.browser.version<8){var r=this.Editor.style.top;this.Editor.style.top="0px";this.Editor.style.top=r}this.Editor.Behavior=this},_DisableFilterEditor:function(){if(!this.Editor.getAttribute("disabled")){this.Editor.setAttribute("disabled","disabled");if(this.TextBox!=null){this.TextBox.setAttribute("disabled","disabled");this.TextBox._bgColor=this.TextBox.style.backgroundColor;this.TextBox.style.backgroundColor="#e0e0e0"}if(this.DropDownButton!=null){this.DropDownButton.setAttribute("disabled","disabled");this.DropDownButton.style.cursor="default";this.DropDownButton._bgColor=this.DropDownButton.style.backgroundColor;this.DropDownButton.style.backgroundColor="#e0e0e0"}if(this.DatePickerButton!=null){this.DatePickerButton.setAttribute("disabled","disabled");this.DatePickerButton.style.cursor="default"}}},_EnableFilterEditor:function(){var a=this.Editor.getAttribute("disabled");if(a=="disabled"||a){this.Editor.removeAttribute("disabled");if(this.TextBox!=null){this.TextBox.removeAttribute("disabled");this.TextBox.style.backgroundColor=this.TextBox._bgColor||"";this.TextBox._bgColor=null}if(this.DropDownButton!=null){this.DropDownButton.removeAttribute("disabled");this.DropDownButton.style.cursor="";this.DropDownButton.style.backgroundColor=this.DropDownButton._bgColor||"";this.DropDownButton._bgColor=null}if(this.DatePickerButton!=null){this.DatePickerButton.removeAttribute("disabled");this.DatePickerButton.style.cursor=""}}},__AdjustForQuirksMode:function(){if(this.IsFilterBar){var b=$$.utils.firstTaggedChild(this.Editor,"INPUT",true);if(b!=null){b.style.marginTop="0px";b.style.marginLeft="1px"}var a=$$(this.Editor).getChildTag("DIV","dropdown"),c=$$(this.Editor).getChildTag("DIV","class","FilterBarDatePicker");if(c!=null){c.style.bottom="-4px";a==null&&c.parentNode.setAttribute("align","center");c.parentNode.setAttribute("valign","middle")}if(a){a.style.position="relative";a.style.bottom="-4px";if(b!=null){a.style.height="16px";a.style.width="16px";a.parentNode.setAttribute("align","center");a.style.right="0px"}else{a.parentNode.setAttribute("align","right");a.style.right="4px"}a.parentNode.setAttribute("valign","middle")}}if(this.__GetMenuType()==GCWS.FilterMenuType.EnhancedMenu&&this.FilterMenu!=null){var h=$$(this.FilterMenu.Holder).getChildTag("DIV","class","TreeHolder");if(h!=null){var e=$$(h).firstChild("DIV");if(e!=null)for(var g=0;g<e.childNodes.length;g++){var f=e.childNodes[g];if(f.nodeType==1&&f.tagName=="TABLE"){var i=$$(f).firstChild("TD");if(i!=null){var d=$$(i).firstChild("A");if(d!=null&&d.style.position=="absolute")d.style.position=""}}}}}},__GetDefaultFilterCommand:function(){var a=this.__GetMenuType();if(a==GCWS.FilterMenuType.EnhancedMenu)a=this.FilterMenu!=null?this.FilterMenu.GetAttribute("CustomFilterMenuType"):"Text";return a+"|="},LayoutEnhancedCell:function(){if(this.__SpreadView.__InDesign){this.Editor.style.height="";if(this.Editor.clientHeight<15)this.Editor.style.height="18px"}},LayoutFilterBar:function(g){var a=this.TextBox;if(a!=null){var d=a.offsetHeight;if(d>0&&a.style.height==""){var f=a.clientHeight-2;a.style.height=f+"px";if(a.offsetHeight!=d)a.style.height=f+d-a.offsetHeight+"px"}}if(!g)if($$.browser.ie&&$$.browser.version<8){var e=$$(this.Editor).firstChild("INPUT");if(e!=null){var b=$$(this.Editor).getChildTag("DIV","dropdown"),c=b!=null?parseInt(b.parentNode.style.width||b.parentNode.width):0;b=$$(this.Editor).getChildTag("DIV","class","FilterBarDatePicker");c+=b!=null?parseInt(b.parentNode.style.width||b.parentNode.width):0;var h=this.Editor.style.overflow;this.Editor.style.overflow="visible";this.Editor.style.overflow=h;if(c>0)e.style.width=Math.max(this.Editor.parentNode.clientWidth-(!isNaN(c)?c:0),0)+"px"}else if(this.DropDownButton!=null)if($$.browser.quirksMode)this.DropDownButton.parentNode.width="";else if(this.__SpreadView.__InDesign){this.DropDownButton.style.marginRight="2px";this.DropDownButton.parentNode.align="right";this.DropDownButton.parentNode.style.width="100%"}}},OnEditorMouseDown:function(g){if(this.Editor.disabled)return;var b=g.target||g.srcElement,a=this.__SpreadView,h=this.Spread,e=a.GetSpreadContext(),n=true;if(a.IsInTouchMode()&&a.IsReadyToFilter()&&document.activeElement!=this.TextBox){setTimeout(function(){a.FocusSpread()},0);return $$.utils.cancelBubble(g)}if(!this.IsFilterBar&&b!=this.DropDownButton)return;if($$.utils.isRightClick(g)&&b!=this.TextBox)return;var d=$$.utils.getDocActiveElement(),D=d==null||!FarPoint.System.IsChild(this.Editor,d),t=false;if(a.IsSpreadActive()){var q=false;(q=h.isEditing())&&e.DoEndEdit({byElement:b,IgnoreFocus:true,RemainFocusOnSpread:a.IsInTouchMode()||a._IsElementHidden(this.Editor.parentNode,$$(this.Editor.parentNode).getParent("TABLE").parentNode,true),SafeEditorRemove:$$.browser.ieversion==10&&window.parent!=window});if(h.isEditing())n=false;else if(q)if(!$$.browser.ie&&d!=null&&$$.utils.isNativeControl(d)&&!$$.utils.contains(this.Editor,d)&&b==this.DatePickerButton){d.blur();a.FocusSpread()}else if(d!=null&&d.tagName=="SELECT")b==this.TextBox&&$$(this.TextBox).focus()}else{e.setActiveSpread(g);n=a.IsSpreadActive()&&this.Spread.IsValid();var p=a.OperationMode!=$$.OperationModes.NORMAL&&a.OperationMode!=$$.OperationModes.ROW_MODE;if(p||a.IsInTouchMode()&&!a.IsRetainSelection()&&a.AllowTapToAddSelection()){if(p&&a.IsInTouchMode()&&a.SelectionModel.IsEmpty()&&h.ActiveRow!=-1){var z=a.IsRowLayoutMode?parseInt(this.Editor.parentNode.parentNode.getAttribute("row")):-1;h.AddSelection(h.ActiveRow,-1,1,-1,z)}e.paintSelections(true,true);t=true}}if(n){e.inactiveAllChart(this.Spread);if(!t&&a.IsInTouchMode()){e.paintSelections(true);a.ShowFocusRectangle()}if(this.IsFilterBar&&GrapeCity.Web.DatePicker.IsShowing()){var r=GrapeCity.Web.DatePicker.GetInstance();(b!=this.DatePickerButton||r.Target!=this.TextBox)&&r.Hide()}a.ClearTimeoutTasks("ProcessEditMode");var x=a.GetTopSpreadView(),j=x.ActiveContextMenu;if(j!=null)if(j.Column!=this.Column||j.Spread!=this.Spread||b!=this.DropDownButton){j.Hide();if(b==this.TextBox)if(a.IsInTouchMode())setTimeout(function(){$$(this.TextBox).focus()},0);else $$(this.TextBox).focus()}var c=this.Spread.getAnchorCell();if(a.OperationMode==$$.OperationModes.NORMAL||a.OperationMode==$$.OperationModes.ROW_MODE)a.SelectFilterColumn(this.Editor.parentNode,c,b==this.TextBox||b==this.DatePickerButton||b==this.DropDownButton,$$.utils.isNativeControl(b));else if(a.IsInTouchMode()){if(!a.SelectionModel.IsEmpty()){for(var m=a._GetActiveCellRange(),A=a._GetColumnIndexFromKey(this.Column),u=false,y=a.IsRowLayoutMode?parseInt(this.Editor.parentNode.parentNode.getAttribute("row")):-1,l=m.Row,w=m.Row+m.RowCount;l<w;l++){if(a.IsRowLayoutMode&&a._GetRow(l).LayoutIndex!=y)continue;var s=a.GetCell(l,A);if(s!=null){a.SetAnchorCell(s,true);u=true;break}}if(!u){var i=this.Editor.parentNode;if(this.IsFilterBar){var o=$$(i).getParent("TABLE");if(!a.IsInFilterBar(o.rows[0])){var B=i.parentNode.rowIndex-o.rows.length/2;i=o.rows[B].cells[i.cellIndex]}}a.SetAnchorCell(i,true)}var c=this.Spread.getAnchorCell();if(b==this.TextBox&&c!=null){var f=this.Spread.getColHeader();if(f!=null)f=f.parentNode;if(f!=null&&$$.utils.contains(f,c)&&c.offsetLeft<f.scrollLeft)f.scrollLeft=Math.floor(c.getBoundingClientRect().left-c.offsetParent.getBoundingClientRect().left)}}}else b==this.TextBox&&a.ScrollToHeaderCell(this.Editor.parentNode);if(b!=this.TextBox&&b!=this.DropDownButton&&b!=this.DatePickerButton&&this.TextBox!=null&&!this.TextBox.disabled)$$(this.TextBox).focus(true);else if(d==this.TextBox&&(b==this.DatePickerButton||b==this.DropDownButton))this.__ignoreFilter=true;else if(b==this.TextBox&&!this.TextBox.disabled){a.ShowEditingFilterIndicator(true);document.activeElement!=null&&document.activeElement!=this.TextBox&&setTimeout(Function.CreateDelegate(this,function(){if($$.browser.ie&&$$.browser.version>9){e.detachScrollEvents();var a=h.getColHeader(),b=-1;if(a!=null){a=a.parentNode;b=a.scrollLeft}}$$(this.TextBox).focus(true);if($$.browser.ie&&$$.browser.version>9){if(b>=0&&a.scrollLeft!=b)a.scrollLeft=b;e.attachScrollEvents()}}),$$.browser.webkit?100:0)}else(this.TextBox==null||this.TextBox.disabled)&&a.FocusSpread();c!=null&&c!=this.Spread.getAnchorCell()&&a.GetSpreadContext().clearSelectedNumericCellTypeCell&&a.GetSpreadContext().clearSelectedNumericCellTypeCell(c);b==this.TextBox&&!this.TextBox.disabled&&a.IsInTouchMode()&&a.Touch.HideTouchHandles(true);return $$.utils.cancelBubble(g,!$$.utils.isNativeControl(b))}else{var C=$$.browser.ie&&$$.browser.version<9;if(C||b==this.TextBox){$$.utils.cancelDefault(g);var v=a.GetActiveSpread();if($$.browser.ie&&v!=null){var k=v.getEditingInfo();k!=null&&k.Editor!=null&&$$.utils.isNativeControl(k.Editor)&&a.RegisterTimeoutTask(function(){$$(k.Editor).focus(true)},0)}}}return true},OnEditorMouseUp:function(a){var c=this.__SpreadView;if(c._GetWorkingSpread()!=null||this.Editor.disabled||!c.IsSpreadActive())return;var g=a.target||a.srcElement,f=$$.utils.isRightClick(a);if(f&&g!=this.TextBox){c.FocusSpread();return}var b=document.activeElement;if(b!=null&&GCWS.FilterEditor.IsFilterControl(b)&&$$.utils.contains(this.Spread,b))return $$.utils.cancelBubble(a,false);var d=a.target||a.srcElement;if(!this.Spread.isEditing()&&!c.GetSpreadContext().isWorking()&&this.Spread.GetActiveChart()==null){var e=GrapeCity.Web.Spread.FilterEditor.GetEditor(d);if(e!=null){$$.browser.ie&&b!=null&&b.tagName=="BODY"&&FarPoint.System.IsChild(this.Editor,d)&&d.focus&&$$(d).focus(false,true);return!c.IsInTouchMode()||e.IsFilterBar||$$.utils.contains(e.Behavior.DropDownButton,d,true)?$$.utils.cancelBubble(a):true}}},OnEditorClick:function(b){if(this.Editor.disabled||!this.__SpreadView.IsSpreadActive())return;var a=b.target||b.srcElement;!$$.browser.ie&&!$$.browser.webkit&&a!=this.TextBox&&a!=this.DropDownButton&&a!=this.DatePickerButton&&this.TextBox!=null&&this.TextBox!=$$.utils.getDocActiveElement()&&$$(this.TextBox).focus(true)},OnFilterBarTextBoxFocus:function(){if(!this.Spread.isEditing()){var a=this.__SpreadView,d=a.Touch;d&&d.HideTouchHandles(true);a.ShowEditingFilterIndicator(true);if(!a.IsInTouchMode()){var c=a.OperationMode==$$.OperationModes.NORMAL||a.OperationMode==$$.OperationModes.ROW_MODE,b=this.Spread.getAnchorCell();if(c&&b!=null&&a._IsCellHidden(b,true))a.GetSpreadContext().scrollToCell(b);else!c&&a.ScrollToHeaderCell(this.Editor.parentNode)}}this.__ignoreFilter=null},OnFilterBarTextBoxBlur:function(a){if(this.__inFiltering){this.__inFiltering=null;return}if($$.browser.mb){var b=this.__SpreadView.Touch;b&&this.__SpreadView.IsInTouchMode()&&b.ShowTouchHandles(false,true)}this.__SpreadView.ShowEditingFilterIndicator(false);var d=a.srcElement||a.target,c=document.activeElement!=null&&FarPoint.System.IsChild(this.Editor,document.activeElement);if(this.__CanFilterByTextBoxBlur()&&!c){if(this.__filterCmd==null||this.__filterCmd.indexOf("|custom")>=0)this.__filterCmd=this.__GetDefaultFilterCommand();setTimeout(Function.CreateDelegate(this,function(){$$.browser.securityWarning&&this.__SpreadView.Spread.ClearSelection();this.__DoFilter(this.__filterCmd+"|"+encodeURIComponent(d.value))}),0);FarPoint.System.CancelDefault(a);return false}},OnFilterBarTextBoxKeyPress:function(a){if(this.__SpreadView.GetEditingSpread()!=null)return $$.utils.cancelBubble(a)},OnKeyDown:function(a){var e=a.srcElement?a.srcElement:a.target,b=this.TextBox,c=e==b;switch(a.keyCode){case GCWS.Keys.ENTER:if(c){if(b.value!=this.__filteredValue){if(this.__filterCmd==null)this.__filterCmd=this.__GetDefaultFilterCommand();this.__inFiltering=true;this.__DoFilter(this.__filterCmd+"|"+b.value)}return $$.utils.cancelDefault(a)}else if(e==this.DatePickerButton){this.OnDatePickerClick(a);$$.utils.cancelDefault(a)}break;case GCWS.Keys.TAB:if(!this.__SpreadView.IsProcessTab())return;var f=$$.browser.ie||!c||b.value==(this.__filteredValue==null?"":this.__filteredValue);if(f){$$.browser.quirksMode&&b.blur();this.__SpreadView.FocusSpread(true,false,true);var d=this.__SpreadView.Spread;d.doGetFocus&&d.getAttribute("EditModePermanent")&&d.doGetFocus()}else b.blur();return $$.browser.ie||!c?$$.utils.cancelDefault(a):$$.utils.cancelBubble(a);case GCWS.Keys.SPACE:if(e==this.DatePickerButton){this.OnDatePickerClick(a);$$.utils.cancelDefault(a)}}return false},OnFilterMenuMouseDown:function(c){var b=c.target||c.srcElement,a=this.__searchBox!=null?this.__searchBox.DropDown:null;if(a!=null&&a.IsShowing()){if(!$$.utils.isNativeControl(b))this.FilterMenu.Focus();else $$(b).focus();a.Hide()}return true},OnFilterMenuItemKeyDown:function(b,a){if(this.__GetMenuType()==GCWS.FilterMenuType.EnhancedMenu)if(this.__searchBox!=null&&b==$$(this.__searchBox.Holder).getParent("LI"))return this.__searchBox.OnKeyDown(a);return true},OnFilterMenuItemClick:function(selectedItem){var menuType=this.__GetMenuType(),cmd=selectedItem.getAttribute("cmd");if(cmd!=null){var dialog=null,handled=false,anchor=$$(selectedItem).firstChild("A");if(this.__IsNoParamFilter(cmd)){this.__DoFilter(cmd);handled=true}else if(cmd.indexOf("Color|")==0){cmd.indexOf("|More")<0&&selectedItem.getAttribute("selected")=="true"&&this.__DoFilter(this.__ResetCommand);if(cmd.indexOf("|More")>=0){var isForeColor=cmd.indexOf("|Back")<0,colors=this.Editor.getAttribute("filter"+(isForeColor?"Fore":"Back")+"Colors");colors='["'+colors.replace(/,/g,'","')+'"]';colors=typeof JSON!="undefined"?JSON.parse(colors):eval(colors);dialog=this.__SpreadView.ShowFilterColorPicker(isForeColor,colors,this.Editor.getAttribute("selected"+(isForeColor?"Fore":"Back")+"Color"),Function.CreateDelegate(this,filterColorPicker));var prevCmd=selectedItem.previousSibling.getAttribute("cmd");dialog.SetNoFill(prevCmd!=null&&prevCmd.lastIndexOf("Color|")==prevCmd.length-6)}else this.__DoFilter(cmd);handled=true}else if(cmd.indexOf("Text|")==0||cmd.indexOf("Number|")==0||cmd.indexOf("Date|")==0){var isTwoParams=this.__IsTwoParamsFilter(cmd);if(this.__IsDynamicFilter(cmd))if(selectedItem.getAttribute("selected")=="true")this.__DoFilter(this.__ResetCommand);else this.__DoFilter(cmd);else{var isFilteredTwoOperator=this.__filteredInfo!=null&&this.__filteredInfo.o2!=null&&this.__filteredInfo.o2.length>0,isSingle=!isTwoParams&&menuType!=GCWS.FilterMenuType.EnhancedMenu;if(isSingle){if(selectedItem.getAttribute("selected"))return true;var menu=selectedItem.Owner;menu.ClearSelectedItems();menu.SelectItem(selectedItem.Index,true);if(this.IsFilterBar){var textBox=$$(this.Editor).firstChild("INPUT");textBox!=null&&$$(textBox).focus()}}if(this.IsFilterBar&&isSingle){var fv="";if(isFilteredTwoOperator)fv=this.__filteredInfo.v1;else{var textbox=$$.utils.firstTaggedChild(this.Editor,"INPUT",true);if(textbox!=null&&textbox.value.length>0)fv=encodeURIComponent(textbox.value)}cmd=cmd+"|"+fv;this.__DoFilter(cmd)}else if(cmd.indexOf("|top10")>=0)dialog=this.__SpreadView.ShowTop10Filter(Function.CreateDelegate(this,top10Filter),Function.CreateDelegate(this,onTop10DialogShown));else{if(this.__filteredInfo!=null)this.__filteredInfo.emptyValues=cmd.indexOf("|custom")<0&&typeof this.__filteredInfo.top10Type!="undefined";dialog=this.__SpreadView.ShowCustomAutoFilter(this.FilterMenu.GetAttribute("CustomFilterMenuType"),Function.CreateDelegate(this,customAutoFilter),Function.CreateDelegate(this,onCustomDialogShown))}}handled=true}else if(cmd.indexOf("Icon|")==0){if(cmd.indexOf("|More")>=0){var icons=JSON.parse(this.Editor.getAttribute("filterIcons"));dialog=this.__SpreadView.ShowFilterIconPicker(icons,this.Editor.getAttribute("selectedIcon"),Function.CreateDelegate(this,filterIconPicker))}else{var iconBox=anchor.firstChild.getAttribute("icon")!=null?anchor.firstChild:$$.utils.firstTaggedChild(anchor.firstChild,"DIV");if(this.Editor.getAttribute("selectedIcon")==iconBox.getAttribute("icon"))this.__DoFilter(this.__ResetCommand);else this.__DoFilter(cmd+iconBox.getAttribute("icon"))}handled=true}if(handled){this.__ignoreFilter=dialog!=null;if(this.__ignoreFilter){dialog.SetCloseCallback(Function.CreateDelegate(this,customDialogClosed));this.IsFilterBar&&this.TextBox!=null&&dialog.SetDateTimeFormat&&dialog.SetDateTimeFormat(this.TextBox._formatString,this.TextBox._dateTimeFormat)}return true}}return false;function top10Filter(b){var a=b.GetFilter(),c="Top10|"+a.top10Dir+"|"+a.top10Rank+"|"+a.top10Type;this.__DoFilter(c)}function onTop10DialogShown(c){var a=this.__filteredInfo,b=a&&a.top10Rank;c.SetFilter(b?a.top10Dir:0,b?a.top10Rank:10,b?a.top10Type:0)}function customAutoFilter(a){var b=this.__GetFilterType(cmd)+"|"+a.GetSelectedCommand();this.__DoFilter(b)}function customDialogClosed(){this.TakeFocus()}function filterColorPicker(c){var a=c.GetSelectedColor(),d=cmd.indexOf("|Back")<0,b=this.Editor.getAttribute("selected"+(d?"Fore":"Back")+"Color");if(a==b)return;this.__DoFilter(cmd.substr(0,cmd.length-4)+a)}function filterIconPicker(b){var a=b.GetSelectedIcon();if(a==parseInt(this.Editor.getAttribute("selectedIcon")))return;this.__DoFilter("Icon|"+a)}function onCustomDialogShown(g){var b=[],f=[],h=true,a=this.__filteredInfo,j=cmd.indexOf("|custom")>=0;if(!j&&a!=null&&a.converted==1)if(a.o2!="")a=null;else if(a.o1=="="){var i=cmd.indexOf("|");if(cmd.substr(i+1,cmd.length-i-1)!=a.o1)a=null}else a=null;var e=a!=null?[a.o1]:[];e.length>0&&a.o2.length>0&&e.push(a.o2);if(j)b=e;else{if(cmd.indexOf("|between")>0)b=[">=","<="];else if(cmd.indexOf("|notbetween")>0){b=["<",">"];h=false}else{var k=cmd.indexOf("|")+1;b=[cmd.substr(k,cmd.length-k)]}var c=b.length==e.length;if(c){for(var d=0;d<b.length;d++)if(b[d]!=e[d])c=false;if(!c&&b.length==2){c=true;for(var d=0;d<2;d++)if(b[d]!=e[1-d])c=false}if(c&&b.length>1)c=h==a.and}if(!c)f=null}if(!a)f=null;if(f!=null){f=b[0]==e[0]?[a.v1,a.v2]:[a.v2,a.v1];if(b.length>1)h=a.and}g.SetSelectedOperators(b);if(a!=null&&a.emptyValues)g.SetText(["",""]);else g.SetText(f);g.SetAnd(h);if(a!=null)a.emptyValues=null}},OnFilterMenuOpening:function(){var e=$$.utils,d=this.__GetMenuType();if(this.__childrenInitialized){this.__AttachEvents();this.__InitTreeState()}else if(d==GCWS.FilterMenuType.EnhancedMenu&&!this.__SpreadView.__InDesign){var f=this.FilterMenu._Items[this.FilterMenu._Items.length-3],g=$$(f).getChildTag("DIV","class","DropDownTextBox");this.__searchBox=new GrapeCity.Web.DropDownTextBox(this.Spread,this,g);var h=this.FilterMenu._Items[this.FilterMenu._Items.length-2],c=$$(h).getChildTag("DIV","class","TreeHolder"),b=e.firstTaggedChild(c,"A");if(b!=null&&b.getAttribute("href").indexOf("_SkipLink")!=-1)b.style.display="none";this.TreeView=e.firstTaggedChild(c,"DIV");this.TreeViewHasTime=this.TreeView.getAttribute("hasTime")!=null;var a=this.TreeView.getElementsByTagName("INPUT");this.__blankCheckBox=this.TreeView.getAttribute("hasBlank")==null?null:a[a.length-1];this.__selectAllCheckBox=a[0];this.__chkAddCurrentSelection=a[1];var i=this.__chkAddCurrentSelection._parentTable=$$(this.__chkAddCurrentSelection).getParent("TABLE");i.style.display="none";this.__treeViewClick=Function.CreateDelegate(this,this.TreeView_OnClick);this.__AttachEvents();this.__InitTreeState(true,a);this.__childrenInitialized=true}d==GCWS.FilterMenuType.EnhancedMenu&&!this.__SpreadView.__InDesign&&this.__searchBox!=null&&this.__searchBox.Reset();if(!this.__SpreadView.__InDesign){this.__contextMenuDel=Function.CreateDelegate(this,function(a){var b=a.target||a.srcElement;if(b==this.DropDownButton&&this.FilterMenu!=null&&this.FilterMenu.IsShowing())return $$.utils.cancelBubble(a)});FarPoint.System.AttachEvent(this.Spread,"contextmenu",this.__contextMenuDel,false)}},OnFilterMenuClosed:function(){if(!this.__SpreadView.__InDesign){this.__GetMenuType()==GCWS.FilterMenuType.EnhancedMenu&&this.__searchBox.InlineImage_OnClick();this.__DetachEvents();FarPoint.System.DetachEvent(this.Spread,"contextmenu",this.__contextMenuDel);if(this.__SpreadView.IsSpreadActive())(!this.IsFilterBar||this.TextBox==null||this.TextBox.disabled)&&this.__SpreadView.FocusSpread()}},TreeView_OnClick:function(b){if(!b)b=window.event;var a=b.srcElement!=null?b.srcElement:b.target,c=a.tagName.toLowerCase()=="input"&&a.type=="checkbox";if(c)if(a==this.__chkAddCurrentSelection)this.__GetOKButton().disabled=!a.checked&&!this.__selectAllCheckBox.checked;else{this.__OnCheckBoxCheckedChanged(a);this.__UpdateOKButton()}},ButtonOK_Click:function(){var c=this.__searchBox.Editor.__searching,b=this.__selectAllCheckBox;if(!c&&b.checked&&b.getAttribute("pc")!="1"){this.FilterMenu.Hide();this.__DoFilter(this.__ResetCommand);return}var a=this.__GetValuesFilterString();a=(this.TreeViewHasTime?"-":"")+this.__dateCount+"|"+a;a="MultiValues|"+a;this.FilterMenu.Hide();this.__DoFilter(a)},ButtonCancle_Click:function(){this.FilterMenu.Hide();this._Refocus()},_Refocus:function(){if(this.IsFilterBar&&this.TextBox!=null)$$(this.TextBox).focus(true);else this.__SpreadView.FocusSpread()},_StopSpreadEditing:function(c){var d=this.Spread.getSpreadView(),a=d.GetEditingSpread();if(a!=null){var h=c.target||c.srcElement,g=a.getSpreadView().GetSpreadContext(),e={byElement:h};if(this.Spread!=a)e.IgnoreFocus=true;g.DoEndEdit(e);a=d.GetEditingSpread()}if(a!=null){var f=document.activeElement,b=a.getEditingInfo().Editor;f!=b&&!$$.utils.contains(b,f)&&$$(b).focus();return $$.utils.cancelBubble(c)}return true},OnDatePickerClick:function(b){var d=b.target||b.srcElement,c=d.getAttribute("disabled");if($$.utils.isRightClick(b)||c=="disabled"||c)return;var a=this.Spread.getSpreadView();if(!a.IsInTouchMode()&&!this._StopSpreadEditing(b)||a.IsInTouchMode()&&!a.TryStopEditing(true,false))return false;if(GrapeCity.Web.DatePicker.IsShowing()){this._Refocus();GrapeCity.Web.DatePicker.GetInstance().Hide();return false}a.UnregisterTimeoutTask("ProcessEditMode");var e=GrapeCity.Web.DatePicker.GetDate(d,this.TextBox,null,a.IsInTouchMode());a.IsInTouchMode()&&GrapeCity.Web.DatePicker.IsShowing()&&a.Touch.ShowTouchHandles(false,true);return e},Search:function(a,b){this.__SearchInternal(null,a,0,b.toLowerCase());this.__searching=true},__SearchInternal:function(k,f,d,p){var b=this.__GetChildCheckBoxes(k);if(b==null)return true;if(k==null)b=b.splice(2,b.length-2);for(var h=0,r=false,m=0;m<b.length;m++){var a=b[m],e=$$(a).getParent("table");if(f==-1||f==d){var q=d>0||this.__IsParentCheckBox(a)?this.__GetCheckBoxTitle(a):this.__GetFilterValue(a);if(q.toLowerCase().indexOf(p.toLowerCase())!=-1){if(!a.checked)a.checked=true;this.__ExpandNode(a);this.__OnCheckBoxCheckedChanged(a);continue}}if(e.style.display=="none")h++;else{if((f==-1||f>d)&&!this.__SearchInternal(a,f,d+1,p))continue;e.style.display="none";if(a.checked)a.checked=false;if(e.nextSibling!=null&&e.nextSibling.tagName=="DIV")for(var n=e.nextSibling.getElementsByTagName("TABLE"),l=0;l<n.length;l++)n[l].style.display="none";h++}}var g=this.__selectAllCheckBox,i=$$(g).getParent("table");if(k==null)if(h==b.length){i.style.display="none";g.checked=false}else if(b.length>0){i.style.display="";var o=this.__AreAllSiblingsChecked(b[0]);if(g!=null){g.checked=o!=0;this.__MakeCheckBoxOpacity(g,o==1)}}if(d==0){var j=i.style.display!="none";if(j){this.__chkAddCurrentSelection._parentTable.style.display="";var c=this.__selectAllCheckBox.nextSibling;c.setAttribute("selectAll",c.innerHTML);c.innerHTML=c.getAttribute("selectAllSearch")}else{this.__chkAddCurrentSelection._parentTable.style.display="none";var c=this.__selectAllCheckBox.nextSibling;if(c.getAttribute("selectAll"))c.innerHTML=c.getAttribute("selectAll")}this.__ShowNoItem(!j);this.__UpdateOKButton(!j)}return h==b.length},ClearSearchResult:function(){if(!this.__searching)return;this.__searching=false;this.__InitTreeState();this.__chkAddCurrentSelection._parentTable.style.display="none";var a=this.__selectAllCheckBox.nextSibling;if(a.getAttribute("selectAll"))a.innerHTML=a.getAttribute("selectAll");this.__ShowNoItem(false)},__UpdateTreeState:function(){var c=this.__IsCheckListChecked();if(this.FilterMenu.GetSelectedItems()!=null&&!c)return;for(var d=this.__GetChildCheckBoxes(),b=2;b<d.length;b++){var a=d[b];if(!c)a.checked=true;else if(!this.__IsParentCheckBox(a))a.checked=false;else a.checked=a.__bchecked;this.__OnCheckBoxCheckedChanged(a)}this.__UpdateOKButton()},__ShowNoItem:function(b){var a=this.TreeView.nextSibling;a.style.display=b?"":"none"},__GetEditingIndicator:function(){var b=this.Spread.getSpreadJS().context,a=b.getCorner();return a!=null?a.rows[a.rows.length-1].cells[0].firstChild:null},__GetFilterType:function(b){var a=b.split("|");return a.length>0?a[0]:null},__Dispose:function(){if(this.__childrenInitialized){this.__searchBox.__Dispose();this.__DetachEvents()}if(this.IsFilterBar){var a=$$(this.Editor).firstChild("INPUT");if(a!=null){FarPoint.System.DetachEvent(a,"focus",this.textBoxFocusHandler);FarPoint.System.DetachEvent(a,"blur",this.textBoxBlurHandler);if(a.__isShowingDatePicker&&(GrapeCity.Web.DatePicker.IsShowing()||!$$.browser.ie)){var b=GrapeCity.Web.DatePicker.GetInstance();if(b.Target==a)if($$.browser.ie)b.Hide();else b.Target.__isShowingDatePicker=null}var c=$$(this.Editor).getChildTag("DIV","class","FilterBarDatePicker");c!=null&&$$.utils.detachEvent(c,"click",this.__onDatePickerMouseClickHandler)}}FarPoint.System.DetachEvent(this.Editor.parentNode,"mousedown",this.editorMouseDownHandler);FarPoint.System.DetachEvent(this.Editor.parentNode,"mouseup",this.editorMouseUpHandler);FarPoint.System.DetachEvent(this.Editor.parentNode,"click",this.editorClickHandler);if(this.FilterMenu!=null){this.FilterMenu.RemoveInternalClickEvent(this.ItemClickEventHandler);this.FilterMenu.RemoveInternalOpeningEvent(this.FilterMenuOpeningEventHandler);this.FilterMenu.RemoveInternalClosedEvent(this.FilterMenuClosedEventHandler)}},__AttachEvents:function(){var a=this.__GetMenuType();if(a==GCWS.FilterMenuType.EnhancedMenu){FarPoint.System.AttachEvent(this.TreeView,"click",this.__treeViewClick);this.__okDel=Function.CreateDelegate(this,this.ButtonOK_Click);FarPoint.System.AttachEvent(this.__GetOKButton(),"click",this.__okDel,false);this.__cancelDel=Function.CreateDelegate(this,this.ButtonCancle_Click);FarPoint.System.AttachEvent(this.__GetCancelButton(),"click",this.__cancelDel,false)}},__GetOKButton:function(){var a=this.FilterMenu._Items[this.FilterMenu._Items.length-1];return $$(a).getChildTag("BUTTON","name","OK")},__GetCancelButton:function(){var a=this.FilterMenu._Items[this.FilterMenu._Items.length-1];return $$(a).getChildTag("BUTTON","name","Cancel")},__DetachEvents:function(){var a=this.__GetMenuType();if(a==GCWS.FilterMenuType.EnhancedMenu){if(this.__okDel!=null){FarPoint.System.DetachEvent(this.__GetOKButton(),"click",this.__okDel);this.__okDel=null}if(this.__cancelDel!=null){FarPoint.System.DetachEvent(this.__GetCancelButton(),"click",this.__cancelDel);this.__cancelDel=null}FarPoint.System.DetachEvent(this.TreeView,"click",this.__treeViewClick)}},__InitTreeState:function(f,b){if(!b)b=this.TreeView.getElementsByTagName("INPUT");if(!f)for(var a=0;a<b.length;a++){var c=b[a];if(c.getAttribute("type")=="checkbox"){c.checked=c.__bchecked;$$(c).removeOrResetAttribute("pc","0");this.__MakeCheckBoxOpacity(c,false);if(c!=this.__chkAddCurrentSelection)$$(c).getParent("TABLE").style.display=""}}var d=this.TreeViewHasTime?this.__GetCheckBoxesAtLevel(false,5):this.__GetCheckBoxesAtLevel(false,2);if(d==null)if(b.length==2){this.__selectAllCheckBox.checked=false;this.__MakeCheckBoxOpacity(this.__selectAllCheckBox,false);this.__selectAllCheckBox.removeAttribute("pc")}else{var g=this.__GetChildCheckBoxes(null,false);g!=null&&this.__CheckUncheckParents(g[0])}else for(var a=0;a<d.length;a++)this.__OnCheckBoxCheckedChanged(d[a]);if(f)for(var a=0;a<b.length;a++){var c=b[a];if(c.getAttribute("type")=="checkbox")c.__bchecked=c.checked}if(b.length<=2)for(var a=0;a<b.length;a++)for(var i=$$(b[a]).getParent("TR"),h=i.cells[0].getElementsByTagName("IMG"),e=0;e<h.length;e++)h[e].style.visibility="hidden";this.__CollapseTree();this.__UpdateOKButton()},__UpdateOKButton:function(a){this.__GetOKButton().disabled=a!=null?a:!this.__selectAllCheckBox.checked&&!this.__chkAddCurrentSelection.checked},__MakeCheckBoxOpacity:function(a,b){if(a==null)return;if(b)$$.utils.appendCssClass(a,"SpreadCheckBoxOpacity");else $$.utils.removeCssClass(a,"SpreadCheckBoxOpacity")},__IsDynamicFilter:function(a){if(a.indexOf("Date|")==0||a.indexOf("Number|")==0){var b=a.split("|");return b.length>2&&b[2]=="Dynamic"}return false},__IsTwoParamsFilter:function(a){return a.indexOf("|between")>0||a.indexOf("|notbetween")>0||a.indexOf("|custom")>0?true:false},__IsNoParamFilter:function(a){return a=="Filter$reset"||a.indexOf("|isempty")>0||a.indexOf("|notisempty")>0||a.indexOf("|isnull")>0||a.indexOf("|notisnull")>0},__GetMenuType:function(){return this.Editor.getAttribute("FilterMenuType")},__CanFilterByTextBoxBlur:function(){if(this.TextBox==null)return false;var a=this.TextBox.__isShowingDatePicker||this.TextBox.value==""&&this.__filteredValue==null||this.__ignoreFilter||this.FilterMenu!=null&&this.FilterMenu.IsShowing();return this.TextBox.value!=this.__filteredValue&&!a},__DoFilter:function(c){var e=this.Spread.getSpreadView(),d=e.GetSpreadContext(),a=this.Spread.getViewport();a=a!=null?a.parentNode:null;if(a!=null)d.saveScrollbarState(0,a.scrollLeft);else d.saveScrollbarState(0,0);var j=this.Spread.getAttribute("ajax")!="false";if(c!=this.__ResetCommand){var k=d.fireAutoFilteringColumn([this.Column],this.__GetFilterDisplayName(c));if(k.cancel)return}var b=e.FilterEditors;if(b!=null)for(var i in b){if(!b[i].IsFilterBar)break;for(var h=b[i].Editor.getElementsByTagName("INPUT"),f=0;f<h.length;f++)h[f].value=""}if(j){this.FilterMenu!=null&&this.FilterMenu.IsShowing()&&this.FilterMenu.Hide();e.ClearTimeoutTasks();g(this);$$.browser.ie&&$$.browser.version<10&&document.releaseCapture();d.syncData(this.Editor.id,c);this.Spread.LoadState=null}else{g(this);__doPostBack(this.Editor.id,c)}function g(c){var a=c.Spread.getSpreadView(),b=a.GetSpreadContext();if(c.IsFilterBar){a.ActivateSpread(c.Spread,true);var d=!a.IsRowLayoutMode?a._GetColumnIndexFromKey(c.Column):c.Column;if(b.getActiveCol()!=d){b.setActiveRow(-1);b.setActiveCol(d);b.selectColumn(d,1,true)}}b.saveData();a.Parent!=null&&a.GetTopSpreadView().SaveAllXmlData()}},__GetFilterDisplayName:function(b){if(b==this.__ResetCommand)return null;var c=b.indexOf("|");if(c!=-1){var a=GcResources[GcResources.GetCulture(this.Spread)].FilterEditor;if(a==null)return;var d=b.substring(0,c);switch(d){case"Text":return a.CustomFilter;case"Number":case"Date":return this.__IsDynamicFilter(b)?a.DynamicFilter:a.CustomFilter;case"Color":return a.ColorFilter;case"Icon":return a.IconFilter;case"Top10":return a.Top10Filter;case"MultiValues":return a.MultiValuesFilter}}return b},TakeFocus:function(){var b=this.__SpreadView,a=$$(this.Editor).firstChild("INPUT");if(a!=null){b.ClearTimeoutTasks("ProcessEditMode");$$(a).focus(true);setTimeout(function(){$$(a).focus(true)},0);b.ShowEditingFilterIndicator(true);return true}else b.FocusSpread();return false},__IsCheckListChecked:function(){if(this.TreeView!=null){var a=$$(this.TreeView).getParent("LI");return a!=null&&a.getAttribute("selected")=="true"}return false},__GetValuesFilterString:function(){var d=this.__GetChildCheckBoxes(),h="|",f="",b=[],g=d[1].checked,e=!this.__IsCheckListChecked();if(g)for(var a=2;a<d.length;a++){var c=d[a];(c.__bchecked||e)&&this.__PushNodeFilterString(c,0,true,b,this.__GetFilterValue(c),false,e)}else b=[];for(var j,i,a=2;a<d.length;a++){var c=d[a];c.checked&&$$(c).getParent("table").style.display==""&&this.__PushNodeFilterString(c,0,false,b,this.__GetFilterValue(c),true)}for(var a=0;a<b.length;a++)b[a]=encodeURIComponent(b[a]);f=b.join(h);return f},__PushNodeFilterString:function(d,f,a,b,c,j,i){var m=a?undefined:true,e=this.__GetChildCheckBoxes(d,m,a,j);if(e!=null)for(var h=0;h<e.length;h++){var k=e[h],l=c+"-"+this.__GetFilterValue(k);this.__PushNodeFilterString(k,f+1,a,b,l,j,i)}else{var g=$$(b).indexOf(c);if(!a&&d.checked||a&&(d.__bchecked||i)&&$$(d).getParent("table").style.display=="none"){if(g<0)if(f>0){b.splice(0,0,c);this.__dateCount++}else b.push(c)}else if(g>=0){b.splice(g,1);if(f>0)this.__dateCount--}}},__GetCheckBoxTitle:function(a){if(a==null)return"";var b=a.nextSibling;return b.innerText||b.textContent},__GetFilterValue:function(a){if(a==null)return"";var b=a.nextSibling;return a==this.__blankCheckBox?" ":b.getAttribute("value")||b.innerText||b.textContent},__GetExpandAnchor:function(a){return $$(a.parentNode.parentNode).firstChild("A")},__CollapseNode:function(checkBox,parentCheckBox){var cbs=this.__GetChildCheckBoxes(checkBox);if(cbs!=null)for(var i=0;i<cbs.length;i++){var cb=cbs[i];this.__CollapseNode(cb,checkBox)}var parentDiv=$$(checkBox).getParent("div");if(parentCheckBox!=null&&parentDiv.style.display!="none"){var parentTable=parentDiv.previousSibling,expandAnchor=$$(parentTable).firstChild("A");if(expandAnchor!=null)try{eval(expandAnchor.href)}catch(e){}}},__ExpandNode:function(checkBox,recursive){var cbTable=$$(checkBox).getParent("TABLE"),parentDiv=$$(checkBox).getParent("div");if(!recursive&&parentDiv.style.display!="none")return;if(parentDiv!=this.TreeView){var parentNodeTable=parentDiv.previousSibling;if(parentNodeTable){var ip=$$(parentNodeTable).firstChild("INPUT");ip!=null&&this.__ExpandNode(ip,true)}}if(recursive){var expandAnchor=$$(cbTable).firstChild("A");if(expandAnchor!=null)try{eval(expandAnchor.href)}catch(e){}}},__CollapseTree:function(){for(var b=this.__GetChildCheckBoxes(null),a=0;a<b.length;a++)this.__CollapseNode(b[a])},__NextSiblingCheckBox:function(c,b){if(c==null)return null;if(!b)b=$$(srcElement).getParent("table");var a=b.nextSibling;while(a!=null&&(a.node.Type!=1||a.tagName!="TABLE"))a=a.nextSibling;return a!=null?$$.utils.firstTaggedChild(a,"INPUT",true):null},__IsParentCheckBox:function(c){var b=$$(c).getParent("table"),a=b.nextSibling;return a!=null&&a.nodeType==1&&a.tagName=="DIV"},__GetChildCheckBoxes:function(h,i,g,c){var k=typeof i=="undefined";if(typeof c=="undefined")c=false;var a;if(h!=null){var j=$$(h).getParent("table"),a=j.nextSibling;if(a==null||a.nodeType!=1||a.tagName!="DIV")return null}else a=this.TreeView;for(var d=[],f=0;f<a.childNodes.length;f++){var b=a.childNodes[f];if(b&&b.nodeType==1&&b.tagName=="TABLE"){if(c&&b.style.display=="none")continue;var e=b.getElementsByTagName("INPUT")[0];(g&&e.__bchecked||!g&&(k||i==e.checked))&&d.push(e)}}return d.length>0?d:null},__GetCheckBoxesAtLevel:function(e,f){for(var a=[],d=this.TreeView.getElementsByTagName("SPAN"),b=0;b<d.length;b++){var c=d[b];parseInt(c.getAttribute("d"))==f&&c.previousSibling.checked==e&&a.push(c.previousSibling)}return a.length>0?a:null},__OnCheckBoxCheckedChanged:function(a){var e=a.getAttribute("pc");if(e=="1")a.checked=true;a.setAttribute("pc","0");var d=this.__selectAllCheckBox;if(a==d){this.__CheckUncheckChildren(this.TreeView,a.checked);this.__MakeCheckBoxOpacity(a,false)}else if(a!=this.__chkAddCurrentSelection){var c=$$(a).getParent("table"),b=c.nextSibling;if(b&&b.nodeType==1)b.tagName.toLowerCase()=="div"&&this.__CheckUncheckChildren(c.nextSibling,a.checked);this.__CheckUncheckParents(a,a.checked);this.__MakeCheckBoxOpacity(a,false)}},__CheckUncheckChildren:function(e,f){for(var c=e.getElementsByTagName("input"),d=c.length,b=0;b<d;b++){var a=c[b];if(a==this.__chkAddCurrentSelection)continue;a.checked=f;a.setAttribute("pc","0");this.__MakeCheckBoxOpacity(a,false)}},__CheckUncheckParents:function(d){var g=$$(d).getParent("div");if(g!=this.TreeView){var f=g.previousSibling,h=$$.utils;if(f){var a=this.__AreAllSiblingsChecked(d),e=f.getElementsByTagName("input");if(e.length>0){var b=e[0];b.checked=a!=0;if(a==1)b.setAttribute("pc","1");else b.setAttribute("pc","0");this.__MakeCheckBoxOpacity(b,a==1);this.__CheckUncheckParents(b)}}}else{var a=this.__AreAllSiblingsChecked(d),c=this.__selectAllCheckBox;if(c!=null){c.checked=a!=0;this.__MakeCheckBoxOpacity(c,a==1);c.setAttribute("pc",a==1?"1":"0")}}},__AreAllSiblingsChecked:function(j){for(var c=$$(j).getParent("div"),i=c.childNodes.length,f=0,e=0,d=false,h=this.__selectAllCheckBox,b=0;b<i;b++)if(c.childNodes[b].nodeType==1){var g=c.childNodes[b];if(g.tagName.toLowerCase()=="table"&&g.style.display!="none"){var a=c.childNodes[b].getElementsByTagName("input")[0];if(a==h||a==this.__chkAddCurrentSelection)continue;if(!d)d=a.getAttribute("pc")=="1";if(a.checked&&a.getAttribute("pc")!="1")e++;f++}}return e==f?2:e>0||d?1:0}};GrapeCity.Web.Spread.FilterEditor.IsFilterCommand=function(a){return a==GrapeCity.Web.Spread.FilterEditor.__ResetCommand||a.indexOf("MultiValues|")==0||a.indexOf("Text|")==0||a.indexOf("Number|")==0||a.indexOf("Date|")==0||a.indexOf("Top10|")==0||a.indexOf("Icon|")==0||a.indexOf("Color|")==0};GrapeCity.Web.Spread.FilterEditor.ShowFilterMenu=function(c){var h=c.srcElement||c.target,a=GCWS.FilterEditor.GetEditor(h);if(a==null||a.Behavior==null)return;var e=a.getAttribute("disabled");if($$.utils.isRightClick(c)||e=="disabled"||e){if(a.Behavior.FilterMenu!=null&&a.Behavior.FilterMenu.IsShowing())a.Behavior.__SpreadView._ignoreMenu=true;return}if(a!=null){var b=a.Behavior,g=b.Spread,f=g.getSpreadView();if(!b._StopSpreadEditing(c))return false;if(b.FilterMenu!=null){var d=b.__SpreadView.GetTopSpreadView().ActiveContextMenu;if(d!=null){b._Refocus();d.Hide()}else{b.FilterMenu.EnableTouchMode(f.IsInTouchMode());b.FilterMenu.Show(c)}}}};GrapeCity.Web.Spread.FilterEditor.IsFilterControl=function(a){if(a==null)return false;else if(a.isFilterControl)return true;var c=GCWS.FilterEditor.GetEditor(a),b=false;if(c!=null){b=a.getAttribute("dropdown")!=null;if(!b&&c.Behavior&&c.Behavior.IsFilterBar)b=a.tagName=="INPUT"||$$(a).getCssClass()=="FilterBarDatePicker"}if(b)a.isFilterControl=true;return b};GrapeCity.Web.Spread.FilterEditor.GetEditor=function(b){var a=b;while(a!=null&&a.nodeType==1&&a.getAttribute("FpSpread")==null){if(a.nodeType==1&&a.getAttribute("fe")!=null)return a;a=a.parentNode}return null};GrapeCity.Web.DropDownTextBox=function(c,a,b){this.Spread=c;this.Editor=a;this.Holder=b;this.DropDown=null;this.TextBox=null;this.ShowWatermark=true;this.WatermarkPrefix="";this.Watermark="";this.DropDownIcon=null;this.InlineImage=null;this.__Initialize()};GrapeCity.Web.DropDownTextBox.prototype={__Initialize:function(){for(var c=$$.utils,b=0;b<this.Holder.childNodes.length;b++)switch(this.Holder.childNodes[b].className){case"DropDownButton":this.DropDownIcon=this.Holder.childNodes[b];break;case"InlineImage":this.InlineImage=this.Holder.childNodes[b]}if(this.DropDownIcon!=null){var d=this.Holder.getAttribute("DropDown");if(d!=null){var a=null;do{a!=null&&a.parentNode.removeChild(a);a=document.getElementById(d)}while(a!=null&&(a.parentNode==document.body||a.parentNode.tagName=="FORM"));var f=c.firstTaggedChild(a,"UL");this.DropDown=new GCWS.DropDownMenu(this.Spread,f,this.DropDownIcon)}this.dropdownIconClickHandler=Function.CreateDelegate(this,this.DropDownIcon_OnClick);FarPoint.System.AttachEvent(this.DropDownIcon,"click",this.dropdownIconClickHandler);this.onDropDownItemClick=Function.CreateDelegate(this,this.DropDown_OnItemClick);this.closedEventHandler=Function.CreateDelegate(this,this.DropDown_OnClosed);this.DropDown.AddInternalClickEvent(this.onDropDownItemClick);this.DropDown.AddInternalClosedEvent(this.closedEventHandler)}this.inlineImageClickHandler=Function.CreateDelegate(this,this.InlineImage_OnClick);FarPoint.System.AttachEvent(this.InlineImage,"click",this.inlineImageClickHandler);this.TextBox=c.firstTaggedChild(this.Holder,"INPUT");this.ShowWatermark=this.Holder.getAttribute("ShowWatermark")!=null;this.WatermarkPrefix=this.Holder.getAttribute("WatermarkPrefix");this.Watermark=this.Holder.getAttribute("Watermark");var e=this.DropDown!=null?c.firstTaggedChild(this.DropDown._Items[0],"A"):null;this.__watermark=this._GetWatermark(e);this.TextBox.value=this.__watermark;this.__UpdateTextBoxState(false);this.textBoxFocusHandler=Function.CreateDelegate(this,this.TextBox_Focus);this.textBoxBlurHandler=Function.CreateDelegate(this,this.TextBox_Blur);this.textBoxKeyUpHandler=Function.CreateDelegate(this,this.TextBox_KeyUp);this.textBoxContextMenuHandler=Function.CreateDelegate(this,this.TextBox_ContextMenu);FarPoint.System.AttachEvent(this.TextBox,"focus",this.textBoxFocusHandler);FarPoint.System.AttachEvent(this.TextBox,"blur",this.textBoxBlurHandler);FarPoint.System.AttachEvent(this.TextBox,"keyup",this.textBoxKeyUpHandler);FarPoint.System.AttachEvent(this.TextBox,"contextmenu",this.textBoxContextMenuHandler);this.Holder.Behavior=this},_GetWatermark:function(a){if(a==null)return this.Watermark;else{var b=(typeof a.textContent!="undefined"?a.textContent:a.innerText).trim();return GcResources.GetCulture(this.Spread)=="ja-JP"?b+" "+this.WatermarkPrefix:this.WatermarkPrefix+" "+b}},Reset:function(){if(this.DropDown!=null)this.DropDown.SelectedItem=null;this.__ShowWatermark(null)},ShowDropDown:function(){this.DropDown.Show()},InlineImage_OnClick:function(){if($$.browser.webkit)setTimeout(Function.CreateDelegate(this,this.__ClearTextBox),500);else this.__ClearTextBox()},DropDownIcon_OnClick:function(){if(this.Editor.FilterMenu.ActiveItem==null)this.Editor.FilterMenu.ActiveItem=$$(this.Holder).getParent("LI");this.DropDown.Show();this.__SetAllowMenuBehavior(false)},DropDown_OnItemClick:function(a){var b=$$.utils;if(this.TextBox.value.length==0||this.TextBox.isEmpty){if(this.ShowWatermark){this.__ShowWatermark(a);a!=this.DropDown._Items[0]&&this.Editor.__UpdateTreeState()}}else!this.TextBox.isEmpty&&this.__SearchTree();return true},DropDown_OnClosed:function(){this.Editor.FilterMenu.IsShowing()&&this.__SetAllowMenuBehavior(true)},TextBox_Focus:function(){var a=$$.utils;if(this.ShowWatermark){a.removeCssClass(this.TextBox,"Watermark");if(this.TextBox.isEmpty)this.TextBox.value=""}this.__SetAllowMenuBehavior(false)},TextBox_Blur:function(){var a=$$.utils;if(this.ShowWatermark&&this.TextBox.isEmpty){a.appendCssClass(this.TextBox,"Watermark");this.TextBox.value=this.__watermark;this.TextBox.processed=false}this.Editor.FilterMenu.IsShowing()&&this.__SetAllowMenuBehavior(true)},OnKeyDown:function(b){var a=true;if(this.DropDown!=null&&this.DropDown.IsShowing())this.DropDown.Hide();else if($$.utils.getDocActiveElement()==this.TextBox){this.stopSearching=true;if(b.keyCode==GCWS.Keys.ESCAPE)if(!this.TextBox.isEmpty&&this.TextBox.value.length>0)this.TextBox.value="";else a=false;else if(b.keyCode!=GCWS.Keys.ESCAPE)this.__oldValue=this.TextBox.value}else a=false;return!a},TextBox_KeyUp:function(b){if($$.browser.mozilla&&b.keyCode==GCWS.Keys.ESCAPE)this.TextBox.value="";if(this.TextBox.value.length==0)this.__UpdateTextBoxState(false);else this.TextBox.value!=this.__oldValue&&!this.TextBox.processed&&this.__UpdateTextBoxState(true);if(this.TextBox.value!=""){this.stopSearching=false;if(!this.searchingTimeoutId||this.searchingTimeoutId<0){var a=Function.CreateDelegate(this,this.__SearchTree);this.searchingTimeoutId=setTimeout(a,200)}}else this.Editor.ClearSearchResult()},TextBox_ContextMenu:function(a){FarPoint.System.CancelDefault(a);return false},__ClearTextBox:function(){if(!this.TextBox.isEmpty){this.TextBox.value=this.__watermark;this.__UpdateTextBoxState(false);this.Editor.ClearSearchResult();$$.browser.webkit&&document.activeElement==this.TextBox&&this.TextBox.blur()}},__SearchTree:function(){this.Editor.ClearSearchResult();if(!this.stopSearching){var a=this.DropDown!=null&&this.DropDown.SelectedItem!=null?this.DropDown.SelectedItem.Index:0;this.Editor.Search(a==0?-1:a-1,this.TextBox.value)}clearTimeout(this.searchingTimeoutId);this.searchingTimeoutId=null},__ShowWatermark:function(a){if(this.DropDown!=null&&a==null)a=this.DropDown._Items[0];$$.utils.appendCssClass(this.TextBox,"Watermark");this.__watermark=this._GetWatermark(a);this.TextBox.value=this.__watermark;this.TextBox.isEmpty=true;this.__UpdateTextBoxState(false)},__UpdateTextBoxState:function(a){this.TextBox.processed=a;this.TextBox.isEmpty=!a;var b=$$.utils;if(a)b.removeCssClass(this.TextBox,"Watermark");else b.appendCssClass(this.TextBox,"Watermark");this.__SwapInlineImage(a)},__SwapInlineImage:function(a){this.InlineImage.className=a?"InlineImageCancel":"InlineImage"},__SetAllowMenuBehavior:function(a){if(!a)this.Editor.FilterMenu.__DetachEvents(true);else this.Editor.FilterMenu.__AttachEvents()},__Dispose:function(){FarPoint.System.DetachEvent(this.TextBox,"focus",this.textBoxFocusHandler);FarPoint.System.DetachEvent(this.TextBox,"blur",this.textBoxBlurHandler);FarPoint.System.DetachEvent(this.TextBox,"keyup",this.textBoxKeyUpHandler);FarPoint.System.DetachEvent(this.TextBox,"contextmenu",this.textBoxContextMenuHandler);if(this.DropDownIcon!=null){FarPoint.System.DetachEvent(this.DropDownIcon,"click",this.dropdownIconClickHandler);this.DropDown.RemoveInternalClickEvent(this.onDropDownItemClick);this.DropDown.RemoveInternalOpeningEvent(this.openingEventHandler);this.DropDown.RemoveInternalClosedEvent(this.closedEventHandler)}FarPoint.System.DetachEvent(this.InlineImage,"click",this.inlineImageClickHandler)}};GrapeCity.Web.DropDownTextBox.ShowDropDown=function(b){var a=b.srcElement?b.srcElement:b.target;while(a!=null){a.nodeType==1&&a.getAttribute("DropDownTextBox")!=null&&a.Behavior.ShowDropDown();a=a.parentNode}};GrapeCity.Web.Spread.DropDownMenu=function(c,b,a){this.Anchor=a;this.SelectedItem=null;GrapeCity.Web.Spread.ContextMenu.call(this,c,null,b)};GrapeCity.Web.Spread.DropDownMenu.prototype=new GrapeCity.Web.Spread.ContextMenu;GrapeCity.Web.Spread.DropDownMenu.prototype.constructor=GrapeCity.Web.Spread.DropDownMenu;GrapeCity.Web.Spread.DropDownMenu.prototype.CanUseAsActiveContextMenu=function(){return false};GrapeCity.Web.Spread.DropDownMenu.prototype.Show=function(){var a=this.Anchor.getBoundingClientRect(),b=a.left+(document.documentElement.scrollLeft||document.body.scrollLeft),c=a.bottom+(document.documentElement.scrollTop||document.body.scrollTop);this.EnableTouchMode(this.__SpreadView.IsInTouchMode());GrapeCity.Web.Spread.ContextMenu.prototype.Show.call(this,b,c);this.SelectedItem!=null&&this.__SetActiveStyle(this.SelectedItem,true);if(this.Anchor!=null){this.__anchorKeyDownHandler=Function.CreateDelegate(this,this.Anchor_OnKeyDown);$$.utils.attachEvent(this.Anchor,"keydown",this.__anchorKeyDownHandler)}};GrapeCity.Web.Spread.DropDownMenu.prototype.Hide=function(){GrapeCity.Web.Spread.ContextMenu.prototype.Hide.call(this);this.Anchor!=null&&this.__anchorKeyDownHandler!=null&&$$.utils.detachEvent(this.Anchor,"keydown",this.__anchorKeyDownHandler)};GrapeCity.Web.Spread.DropDownMenu.prototype.OnItemClick=function(a){var b=$$.utils.FindParent(a.target||a.srcElement,"LI");if(b==null)return;this.SelectedItem!=null&&this.__SetActiveStyle(this.SelectedItem,false);this.SelectedItem=b;GrapeCity.Web.Spread.ContextMenu.prototype.OnItemClick.call(this,a)};GrapeCity.Web.Spread.DropDownMenu.prototype.OnHoverItem=function(){this.SelectedItem!=null&&this.__SetActiveStyle(this.SelectedItem,false);GrapeCity.Web.Spread.ContextMenu.prototype.OnHoverItem.apply(this,arguments)};GrapeCity.Web.Spread.DropDownMenu.prototype.Anchor_OnKeyDown=function(a){if(a.keyCode==GCWS.Keys.ESCAPE){this.Hide();return $$.utils.cancelBubble(a)}};GrapeCity.Web.Spread.FilterMenuType={DateTime:"Date",Text:"Text",Number:"Number",EnhancedMenu:"Enhanced"};GrapeCity.Web.Spread.FilterEditor.__ResetCommand="Filter$reset"